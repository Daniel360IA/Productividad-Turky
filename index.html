<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turky - Control de Productividad v2</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#1a5f2a;--primary-light:#2d8a42;--accent:#f59e0b;--danger:#dc2626;--success:#16a34a;--warning:#ea580c;--bg-dark:#0c1810;--bg-card:#132419;--bg-input:#1a3324;--text-primary:#e8f5ec;--text-secondary:#9cb8a6;--text-muted:#5a7d66;--border:#2d5a3d;--crudos:#3b82f6;--apanados:#f59e0b;--derivados:#8b5cf6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh}
        .header{background:linear-gradient(135deg,var(--bg-card) 0%,#0f3d1a 100%);border-bottom:1px solid var(--border);padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .logo{display:flex;align-items:center;gap:0.75rem}.logo-icon{width:42px;height:42px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}.logo-text{font-size:1.4rem;font-weight:700}.logo-text span{color:var(--accent)}
        .header-info{display:flex;align-items:center;gap:1rem}.header-date{font-family:'JetBrains Mono',monospace;font-size:0.85rem;color:var(--text-secondary);background:var(--bg-input);padding:0.5rem 1rem;border-radius:8px;border:1px solid var(--border)}
        .user-badge{display:flex;align-items:center;gap:0.75rem;background:var(--bg-input);padding:0.5rem 1rem;border-radius:8px;border:1px solid var(--border);cursor:pointer}.user-avatar{width:32px;height:32px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.8rem}.user-name{font-size:0.85rem;font-weight:600}.user-role{font-size:0.7rem;color:var(--text-secondary)}
        .nav-container{background:var(--bg-card);border-bottom:1px solid var(--border);padding:0 1rem;overflow-x:auto}.nav-tabs{display:flex;gap:0.25rem}.nav-tab{padding:1rem 0.75rem;font-size:0.75rem;font-weight:500;color:var(--text-secondary);background:transparent;border:none;cursor:pointer;position:relative;white-space:nowrap;transition:all 0.2s}.nav-tab:hover{color:var(--text-primary)}.nav-tab.active{color:var(--accent)}.nav-tab.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--accent);border-radius:3px 3px 0 0}
        .main-content{padding:1.5rem;max-width:1600px;margin:0 auto}.screen{display:none}.screen.active{display:block;animation:fadeIn 0.3s ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:1rem;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:0.5rem}.card-title{font-size:1rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}
        .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:1.5rem}.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}@media(max-width:1200px){.grid-4{grid-template-columns:repeat(2,1fr)}}@media(max-width:768px){.grid-2,.grid-4{grid-template-columns:1fr}}
        .stat-card{background:var(--bg-input);border:1px solid var(--border);border-radius:12px;padding:1.25rem;position:relative;overflow:hidden}.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--primary)}.stat-card.crudos::before{background:var(--crudos)}.stat-card.apanados::before{background:var(--apanados)}.stat-card.derivados::before{background:var(--derivados)}.stat-label{font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.5rem}.stat-value{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700}.stat-unit{font-size:0.8rem;color:var(--text-secondary);font-weight:400}
        .form-group{margin-bottom:1rem}.form-label{display:block;font-size:0.8rem;font-weight:500;color:var(--text-secondary);margin-bottom:0.5rem}.form-input,.form-select{width:100%;padding:0.75rem 1rem;font-size:0.9rem;font-family:inherit;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;color:var(--text-primary)}.form-input:focus,.form-select:focus{outline:none;border-color:var(--primary-light)}.form-select option{background:var(--bg-dark);color:var(--text-primary)}.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.5rem;font-size:0.9rem;font-weight:600;font-family:inherit;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-light)}.btn-secondary{background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border)}.btn-danger{background:var(--danger);color:white}.btn-sm{padding:0.5rem 1rem;font-size:0.8rem}.btn-lg{padding:1rem 2rem;font-size:1rem}.btn-block{width:100%}
        .table-container{overflow-x:auto;border-radius:8px;border:1px solid var(--border)}.table{width:100%;border-collapse:collapse;font-size:0.8rem}.table th{background:var(--bg-input);padding:0.75rem;text-align:left;font-weight:600;color:var(--text-secondary);text-transform:uppercase;font-size:0.65rem;border-bottom:1px solid var(--border)}.table td{padding:0.75rem;border-bottom:1px solid var(--border)}.table tr:last-child td{border-bottom:none}.table tr:hover td{background:rgba(26,95,42,0.1)}
        .badge{display:inline-flex;padding:0.25rem 0.6rem;font-size:0.65rem;font-weight:600;border-radius:20px;text-transform:uppercase}.badge-crudos{background:rgba(59,130,246,0.2);color:var(--crudos)}.badge-apanados{background:rgba(245,158,11,0.2);color:var(--apanados)}.badge-derivados{background:rgba(139,92,246,0.2);color:var(--derivados)}.badge-success{background:rgba(22,163,74,0.2);color:var(--success)}.badge-warning{background:rgba(234,88,12,0.2);color:var(--warning)}.badge-danger{background:rgba(220,38,38,0.2);color:var(--danger)}
        .line-selector{display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap}.line-btn{flex:1;min-width:80px;padding:0.75rem;background:var(--bg-input);border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center}.line-btn:hover{border-color:#3d7a52}.line-btn.active{border-color:var(--primary-light);background:rgba(26,95,42,0.2)}.line-btn.crudos.active{border-color:var(--crudos);background:rgba(59,130,246,0.15)}.line-btn.apanados.active{border-color:var(--apanados);background:rgba(245,158,11,0.15)}.line-btn.derivados.active{border-color:var(--derivados);background:rgba(139,92,246,0.15)}.line-btn-label{font-size:0.6rem;color:var(--text-muted);text-transform:uppercase}.line-btn-name{font-size:0.85rem;font-weight:600;margin-top:0.25rem}.line-btn.crudos .line-btn-name{color:var(--crudos)}.line-btn.apanados .line-btn-name{color:var(--apanados)}.line-btn.derivados .line-btn-name{color:var(--derivados)}
        .progress-bar{height:8px;background:var(--bg-input);border-radius:4px;overflow:hidden}.progress-fill{height:100%;background:var(--primary);border-radius:4px;transition:width 0.3s}
        .operario-chips{display:flex;flex-wrap:wrap;gap:0.5rem}.operario-chip{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--bg-input);border:1px solid var(--border);border-radius:20px;font-size:0.8rem;cursor:pointer}.operario-chip:hover{border-color:var(--primary-light)}.operario-chip.selected{background:var(--primary);border-color:var(--primary);color:white}.operario-chip-avatar{width:24px;height:24px;background:var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:600}.operario-chip.selected .operario-chip-avatar{background:rgba(255,255,255,0.2)}
        .quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:1rem}.quick-action{background:var(--bg-input);border:1px solid var(--border);border-radius:12px;padding:1rem;cursor:pointer;text-align:center}.quick-action:hover{border-color:var(--primary-light)}.quick-action-icon{width:40px;height:40px;margin:0 auto 0.5rem;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem}.quick-action-title{font-weight:600;font-size:0.8rem}.quick-action-desc{font-size:0.7rem;color:var(--text-secondary)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:all 0.3s;padding:1rem}.modal-overlay.active{opacity:1;visibility:visible}.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:100%;max-width:650px;max-height:90vh;overflow-y:auto;transform:scale(0.9);transition:transform 0.3s}.modal-overlay.active .modal{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg-card);z-index:10}.modal-title{font-size:1rem;font-weight:600}.modal-close{width:32px;height:32px;background:var(--bg-input);border:none;border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:1.2rem}.modal-close:hover{background:var(--danger);color:white}.modal-body{padding:1.5rem}.modal-footer{display:flex;justify-content:flex-end;gap:0.75rem;padding:1rem 1.5rem;border-top:1px solid var(--border)}
        .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}.login-card{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:2.5rem;width:100%;max-width:400px;text-align:center}.login-logo{width:70px;height:70px;margin:0 auto 1.5rem;background:var(--primary);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.8rem}.login-title{font-size:1.5rem;font-weight:700;margin-bottom:0.5rem}.login-subtitle{color:var(--text-secondary);margin-bottom:2rem}
        .empty-state{text-align:center;padding:2rem;color:var(--text-secondary)}.empty-state-icon{font-size:2.5rem;margin-bottom:1rem;opacity:0.5}
        .toast-container{position:fixed;bottom:2rem;right:2rem;z-index:2000;display:flex;flex-direction:column;gap:0.75rem}.toast{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:1rem;display:flex;align-items:center;gap:0.75rem;animation:slideIn 0.3s ease;min-width:250px}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}.toast.success{border-left:4px solid var(--success)}.toast.warning{border-left:4px solid var(--warning)}.toast-icon{font-size:1.2rem}.toast.success .toast-icon{color:var(--success)}.toast.warning .toast-icon{color:var(--warning)}
        .text-mono{font-family:'JetBrains Mono',monospace}.text-center{text-align:center}.mt-2{margin-top:1rem}.mt-3{margin-top:1.5rem}.mb-2{margin-bottom:1rem}.flex{display:flex}.flex-between{justify-content:space-between}.gap-2{gap:1rem}.hidden{display:none!important}
        .hora-registro{display:flex;align-items:center;gap:1rem;padding:1rem;background:var(--bg-input);border-radius:8px;margin-bottom:1rem;flex-wrap:wrap}.hora-registro-label{font-size:0.8rem;color:var(--text-secondary)}.hora-registro-value{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:600;color:var(--accent)}
        .turno-selector{display:flex;gap:0.5rem}.turno-btn{flex:1;padding:0.5rem;background:var(--bg-input);border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;color:var(--text-primary)}.turno-btn.active{border-color:var(--accent);background:rgba(245,158,11,0.15)}.turno-btn-name{font-weight:600;font-size:0.85rem}.turno-btn-hours{font-size:0.7rem;color:var(--text-secondary)}
        .merma-type-selector{display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem}.merma-type-btn{padding:0.5rem;background:var(--bg-input);border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;font-size:0.75rem;font-weight:500;color:var(--text-primary)}.merma-type-btn.active{border-color:var(--danger);background:rgba(220,38,38,0.15);color:#ef4444}@media(max-width:500px){.merma-type-selector{grid-template-columns:repeat(2,1fr)}}
        .items-list{border:1px solid var(--border);border-radius:8px;margin-top:0.5rem;max-height:180px;overflow-y:auto}.item-row{display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);font-size:0.8rem}.item-row:last-child{border-bottom:none}.item-row .item-info{flex:1;min-width:0}.item-row .item-name{font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.item-row .item-qty{font-family:'JetBrains Mono',monospace;color:var(--text-secondary);font-size:0.75rem}.item-row .btn-remove{width:24px;height:24px;padding:0;border-radius:4px;flex-shrink:0}
        .info-box{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;padding:0.75rem;margin-bottom:1rem}.info-box-title{font-weight:600;font-size:0.8rem;margin-bottom:0.25rem}.info-box-text{font-size:0.75rem;color:var(--text-secondary)}
        .consecutivo-display{display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap}.consecutivo-item{background:var(--bg-input);border:1px solid var(--border);border-radius:8px;padding:0.5rem 1rem;text-align:center}.consecutivo-label{font-size:0.65rem;color:var(--text-muted);text-transform:uppercase}.consecutivo-value{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:600;color:var(--accent)}
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">ü¶É</div>
            <h1 class="login-title">Turky<span style="color:var(--accent)">.</span></h1>
            <p class="login-subtitle">Control de Productividad v2</p>
            <div class="form-group"><label class="form-label">Selecciona tu usuario</label><select id="loginUser" class="form-select"><option value="">-- Seleccionar --</option></select></div>
            <button class="btn btn-primary btn-block btn-lg" onclick="doLogin()">Ingresar</button>
        </div>
    </div>
    <div id="mainApp" class="hidden">
        <header class="header">
            <div class="logo"><div class="logo-icon">ü¶É</div><div class="logo-text">Turky<span>.</span></div></div>
            <div class="header-info"><div class="header-date" id="headerDate"></div><div class="user-badge" onclick="logout()"><div class="user-avatar" id="userAvatar"></div><div class="user-info"><div class="user-name" id="userName"></div><div class="user-role" id="userRole"></div></div></div></div>
        </header>
        <nav class="nav-container"><div class="nav-tabs">
            <button class="nav-tab active" data-screen="dashboard">üìä Dashboard</button>
            <button class="nav-tab" data-screen="ordenes">üìã √ìrdenes</button>
            <button class="nav-tab" data-screen="produccion">‚öôÔ∏è Producci√≥n</button>
            <button class="nav-tab" data-screen="empaques">üì¶ Empaques</button>
            <button class="nav-tab" data-screen="mermas">üìâ Mermas</button>
            <button class="nav-tab" data-screen="productividad">üë• Productividad</button>
            <button class="nav-tab" data-screen="reportes">üìà Reportes</button>
        </div></nav>
        <main class="main-content" id="mainContent"></main>
    </div>
    <div id="modalNuevaOrden" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Nueva Orden de Producci√≥n</h3><button class="modal-close" onclick="closeModal('modalNuevaOrden')">√ó</button></div>
            <div class="modal-body">
                <div class="consecutivo-display"><div class="consecutivo-item"><div class="consecutivo-label">Consec. Sistema</div><div class="consecutivo-value" id="ordenConsecSistema">OP-0001</div></div><div class="consecutivo-item" style="flex:1"><div class="consecutivo-label">Consec. Interno</div><input type="text" id="ordenConsecInterno" class="form-input" placeholder="Ej: 2024-001" style="margin-top:0.25rem;padding:0.5rem"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">L√≠nea</label><select id="ordenLinea" class="form-select" onchange="cargarProductosLinea()"><option value="">-- Seleccionar --</option><option value="CRUDOS">Crudos</option><option value="APANADOS">Apanados</option><option value="DERIVADOS">Derivados</option></select></div><div class="form-group"><label class="form-label">Fecha</label><input type="date" id="ordenFecha" class="form-input"></div></div>
                <div class="card" style="padding:1rem;margin-bottom:1rem;background:var(--bg-input)"><h4 style="font-size:0.85rem;margin-bottom:0.75rem">‚ûï Agregar √çtem</h4>
                    <div class="form-row"><div class="form-group" style="flex:2"><label class="form-label">Producto</label><select id="ordenProducto" class="form-select"><option value="">-- Primero selecciona l√≠nea --</option></select></div><div class="form-group"><label class="form-label">Cantidad</label><input type="number" id="ordenCantidad" class="form-input" placeholder="0"></div><div class="form-group"><label class="form-label">Unidad</label><select id="ordenUnidad" class="form-select"><option value="kg">kg</option><option value="und">und</option></select></div></div>
                    <div class="form-row"><div class="form-group"><label class="form-label">Lote</label><input type="text" id="ordenLote" class="form-input" placeholder="L240126"></div><div class="form-group"><label class="form-label">Vencimiento</label><input type="date" id="ordenVencimiento" class="form-input"></div><div class="form-group" style="display:flex;align-items:flex-end"><button class="btn btn-secondary btn-sm" onclick="agregarItemOrden()">+ Agregar</button></div></div>
                </div>
                <div class="form-label">√çtems (<span id="itemsCount">0</span>)</div>
                <div class="items-list" id="itemsOrdenList"><div class="empty-state" style="padding:1rem"><p style="font-size:0.8rem">No hay √≠tems</p></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalNuevaOrden');limpiarOrdenModal()">Cancelar</button><button class="btn btn-primary" onclick="guardarOrden()">üíæ Guardar</button></div>
        </div>
    </div>
    <div id="modalEmpaque" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Registrar Empaque</h3><button class="modal-close" onclick="closeModal('modalEmpaque')">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Auxiliar</label><select id="empaqueOperario" class="form-select"><option value="">-- Seleccionar --</option></select></div>
                <div class="form-row"><div class="form-group"><label class="form-label">L√≠nea</label><select id="empaqueLinea" class="form-select" onchange="cargarProductosEmpaque()"><option value="">-- Seleccionar --</option><option value="CRUDOS">Crudos</option><option value="APANADOS">Apanados</option><option value="DERIVADOS">Derivados</option></select></div><div class="form-group"><label class="form-label">Producto</label><select id="empaqueProducto" class="form-select"><option value="">-- Selecciona l√≠nea --</option></select></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Unidades</label><input type="number" id="empaqueUnidades" class="form-input" placeholder="0"></div><div class="form-group"><label class="form-label">Kg</label><input type="number" id="empaqueKg" class="form-input" step="0.01" placeholder="0.00"></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Hora Inicio</label><input type="time" id="empaqueHoraInicio" class="form-input"></div><div class="form-group"><label class="form-label">Hora Fin</label><input type="time" id="empaqueHoraFin" class="form-input"></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalEmpaque')">Cancelar</button><button class="btn btn-primary" onclick="guardarEmpaque()">üíæ Guardar</button></div>
        </div>
    </div>
    <div id="modalProductividad" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Registrar Productividad</h3><button class="modal-close" onclick="closeModal('modalProductividad')">√ó</button></div>
            <div class="modal-body">
                <div id="infoCoccionDerivados" class="info-box hidden"><div class="info-box-title">‚è±Ô∏è Cocci√≥n Derivados</div><div class="info-box-text">Tiempo est√°ndar: <strong>2h 15min - 2h 30min</strong></div></div>
                <div class="form-group"><label class="form-label">Operario</label><select id="prodOperario" class="form-select"><option value="">-- Seleccionar --</option></select></div>
                <div class="form-row"><div class="form-group"><label class="form-label">L√≠nea</label><select id="prodLineaOp" class="form-select" onchange="cargarEstacionesLinea();mostrarInfoCoccion()"><option value="">-- Seleccionar --</option><option value="CRUDOS">Crudos</option><option value="APANADOS">Apanados</option><option value="DERIVADOS">Derivados</option></select></div><div class="form-group"><label class="form-label">Estaci√≥n</label><select id="prodEstacionOp" class="form-select"><option value="">-- Selecciona l√≠nea --</option></select></div></div>
                <div class="form-row"><div class="form-group"><label class="form-label">Unidades</label><input type="number" id="prodUnidadesOp" class="form-input" placeholder="0"></div><div class="form-group"><label class="form-label">Horas</label><input type="number" id="prodHorasOp" class="form-input" step="0.25" placeholder="0"></div></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modalProductividad')">Cancelar</button><button class="btn btn-primary" onclick="guardarProductividad()">üíæ Guardar</button></div>
        </div>
    </div>
    <div class="toast-container" id="toastContainer"></div>
" style="padding:2rem;color:var(--text-muted)">No hay √≥rdenes</td></tr>';return;}tb.innerHTML=list.map(o=>'<tr><td class="text-mono">'+o.consecSistema+'</td><td class="text-mono">'+o.consecInterno+'</td><td><span class="badge badge-'+o.linea.toLowerCase()+'">'+o.linea+'</span></td><td>'+o.items.length+'</td><td class="text-mono">'+o.fecha+'</td><td><span class="badge badge-'+(o.estado==='completada'?'success':o.estado==='en_proceso'?'warning':'danger')+'">'+o.estado+'</span></td></tr>').join('');}
function abrirModalEmpaque(){document.getElementById('empaqueOperario').value='';document.getElementById('empaqueLinea').value='';document.getElementById('empaqueProducto').innerHTML='<option value="">-- Selecciona l√≠nea --</option>';document.getElementById('empaqueUnidades').value='';document.getElementById('empaqueKg').value='';document.getElementById('empaqueHoraInicio').value=new Date().toTimeString().slice(0,5);document.getElementById('empaqueHoraFin').value='';populateSelects();openModal('modalEmpaque');}
function cargarProductosEmpaque(){const l=document.getElementById('empaqueLinea').value,s=document.getElementById('empaqueProducto');s.innerHTML='<option value="">-- Seleccionar --</option>';if(l&&PRODUCTOS[l])PRODUCTOS[l].forEach(p=>s.innerHTML+='<option value="'+p.codigo+'">'+p.descripcion+'</option>');}
function guardarEmpaque(){const opId=document.getElementById('empaqueOperario').value,linea=document.getElementById('empaqueLinea').value,producto=document.getElementById('empaqueProducto').value,unidades=parseInt(document.getElementById('empaqueUnidades').value)||0,kg=parseFloat(document.getElementById('empaqueKg').value)||0,horaInicio=document.getElementById('empaqueHoraInicio').value,horaFin=document.getElementById('empaqueHoraFin').value;if(!opId||!linea||!producto||(unidades===0&&kg===0)){showToast('Completa los campos','warning');return;}const op=OPERARIOS.find(o=>o.id===opId);const prod=PRODUCTOS[linea].find(p=>p.codigo===producto);empaques.push({id:Date.now().toString(),fecha:new Date().toISOString().split('T')[0],operarioId:opId,operarioNombre:op.nombre,linea:linea,productoCodigo:producto,productoNombre:prod.descripcion,unidades:unidades,kg:kg,horaInicio:horaInicio,horaFin:horaFin,registradoPor:currentUser.id});saveData();closeModal('modalEmpaque');showToast('Empaque registrado','success');refreshEmpaques();}
function refreshEmpaques(){const tb=document.getElementById('tableEmpaques');if(!tb)return;const t=new Date().toISOString().split('T')[0];const list=empaques.filter(e=>e.fecha===t);const uc=list.filter(e=>e.linea==='CRUDOS').reduce((s,e)=>s+e.unidades,0);const ua=list.filter(e=>e.linea==='APANADOS').reduce((s,e)=>s+e.unidades,0);const ud=list.filter(e=>e.linea==='DERIVADOS').reduce((s,e)=>s+e.unidades,0);const kgt=list.reduce((s,e)=>s+e.kg,0);const ec=document.getElementById('statEmpCrudos'),ea=document.getElementById('statEmpApanados'),ed=document.getElementById('statEmpDerivados'),ek=document.getElementById('statEmpKgTotal');if(ec)ec.textContent=uc;if(ea)ea.textContent=ua;if(ed)ed.textContent=ud;if(ek)ek.textContent=kgt.toFixed(1);if(list.length===0){tb.innerHTML='<tr><td colspan="6" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay empaques</td></tr>';return;}tb.innerHTML=list.map(e=>'<tr><td>'+e.operarioNombre.split(' ')[0]+'</td><td><span class="badge badge-'+e.linea.toLowerCase()+'">'+e.linea+'</span></td><td>'+e.productoNombre.substring(0,15)+'...</td><td class="text-mono">'+e.unidades+'</td><td class="text-mono">'+e.kg+'</td><td class="text-mono">'+e.horaInicio+'-'+(e.horaFin||'--')+'</td></tr>').join('');}
function filterEmpaques(f,btn){document.querySelectorAll('#mainContent .line-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');const tb=document.getElementById('tableEmpaques');const t=new Date().toISOString().split('T')[0];let list=empaques.filter(e=>e.fecha===t);if(f!=='todas')list=list.filter(e=>e.linea===f);if(list.length===0){tb.innerHTML='<tr><td colspan="6" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay empaques</td></tr>';return;}tb.innerHTML=list.map(e=>'<tr><td>'+e.operarioNombre.split(' ')[0]+'</td><td><span class="badge badge-'+e.linea.toLowerCase()+'">'+e.linea+'</span></td><td>'+e.productoNombre.substring(0,15)+'...</td><td class="text-mono">'+e.unidades+'</td><td class="text-mono">'+e.kg+'</td><td class="text-mono">'+e.horaInicio+'-'+(e.horaFin||'--')+'</td></tr>').join('');}
function selectLineaProduccion(l,btn){document.querySelectorAll('#mainContent .line-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedLinea=l;document.getElementById('produccionEmpty').classList.add('hidden');document.getElementById('produccionForm').classList.remove('hidden');const infoCoccion=document.getElementById('infoCoccionProd');if(infoCoccion){if(l==='DERIVADOS')infoCoccion.classList.remove('hidden');else infoCoccion.classList.add('hidden');}const s=document.getElementById('prodOrden');const t=new Date().toISOString().split('T')[0];const ordenesLinea=ordenes.filter(o=>o.linea===l&&o.fecha===t&&o.estado!=='completada');s.innerHTML='<option value="">-- Seleccionar --</option>';ordenesLinea.forEach(o=>s.innerHTML+='<option value="'+o.id+'">'+o.consecSistema+' ('+o.items.length+' items)</option>');const cc=document.getElementById('operariosChips');const ops=OPERARIOS.filter(o=>o.planta===l||o.planta==='TODA LA PRODUCCION');cc.innerHTML='';selectedOperarios=[];ops.forEach(op=>{const i=op.nombre.split(' ').map(n=>n[0]).slice(0,2).join('');cc.innerHTML+='<div class="operario-chip" onclick="toggleOperario(\''+op.id+'\',this)"><div class="operario-chip-avatar">'+i+'</div><span>'+op.nombre.split(' ')[0]+'</span></div>';});document.getElementById('prodHoraInicio').value=new Date().toTimeString().slice(0,5);}
function selectTurno(t,btn){document.querySelectorAll('.turno-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedTurno=t;}
function toggleOperario(id,chip){chip.classList.toggle('selected');selectedOperarios=selectedOperarios.includes(id)?selectedOperarios.filter(o=>o!==id):selectedOperarios.concat([id]);}
function calcRendimiento(){const pi=parseFloat(document.getElementById('prodPesoInicial').value)||0,pf=parseFloat(document.getElementById('prodPesoFinal').value)||0;document.getElementById('prodRendimiento').value=pi>0&&pf>0?((pf/pi)*100).toFixed(2)+'%':'---%';}
function guardarProduccion(){const oid=document.getElementById('prodOrden').value,hi=document.getElementById('prodHoraInicio').value,hf=document.getElementById('prodHoraFin').value,pi=parseFloat(document.getElementById('prodPesoInicial').value)||0,pf=parseFloat(document.getElementById('prodPesoFinal').value)||0,u=parseInt(document.getElementById('prodUnidades').value)||0,k=parseFloat(document.getElementById('prodKg').value)||0;if(!oid||!hi||pi===0){showToast('Completa los campos','warning');return;}const o=ordenes.find(x=>x.id===oid);const r=pi>0?((pf/pi)*100).toFixed(2):0;produccion.push({id:Date.now().toString(),fecha:new Date().toISOString().split('T')[0],ordenId:oid,ordenConsec:o?o.consecSistema:'',linea:selectedLinea,turno:selectedTurno,horaInicio:hi,horaFin:hf,pesoInicial:pi,pesoFinal:pf,rendimiento:r,unidades:u,kg:k,operarios:selectedOperarios,registradoPor:currentUser.id});if(o)o.estado='en_proceso';saveData();showToast('Producci√≥n registrada','success');limpiarProduccion();refreshProduccionTable();}
function limpiarProduccion(){['prodOrden','prodHoraFin','prodPesoInicial','prodPesoFinal','prodUnidades','prodKg'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});document.getElementById('prodRendimiento').value='---%';selectedOperarios=[];document.querySelectorAll('.operario-chip').forEach(c=>c.classList.remove('selected'));}
function refreshProduccionTable(){const tb=document.getElementById('tableProduccion');if(!tb)return;const t=new Date().toISOString().split('T')[0];const list=produccion.filter(p=>p.fecha===t);if(list.length===0){tb.innerHTML='<tr><td colspan="6" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay registros</td></tr>';return;}tb.innerHTML=list.map(p=>'<tr><td class="text-mono">'+p.horaInicio+'-'+(p.horaFin||'--')+'</td><td><span class="badge badge-'+p.linea.toLowerCase()+'">'+p.linea+'</span></td><td class="text-mono">'+p.ordenConsec+'</td><td class="text-mono">'+p.pesoInicial+'</td><td class="text-mono">'+p.pesoFinal+'</td><td class="text-mono">'+p.rendimiento+'%</td></tr>').join('');}
function selectLineaMerma(l,btn){document.querySelectorAll('#mainContent .line-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedLinea=l;document.getElementById('mermaEmpty').classList.add('hidden');document.getElementById('mermaForm').classList.remove('hidden');const s=document.getElementById('mermaEstacion');s.innerHTML='<option value="">-- Seleccionar --</option>';ESTACIONES[l].forEach(e=>s.innerHTML+='<option value="'+e+'">'+e+'</option>');}
function selectTipoMerma(t,btn){document.querySelectorAll('.merma-type-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');selectedTipoMerma=t;}
function guardarMerma(){const p=parseFloat(document.getElementById('mermaPeso').value)||0,e=document.getElementById('mermaEstacion').value,c=document.getElementById('mermaCausa').value;if(p===0||!e){showToast('Completa peso y estaci√≥n','warning');return;}mermas.push({id:Date.now().toString(),fecha:new Date().toISOString().split('T')[0],hora:new Date().toLocaleTimeString('es-CO',{hour:'2-digit',minute:'2-digit'}),linea:selectedLinea,tipo:selectedTipoMerma,peso:p,estacion:e,causa:c,registradoPor:currentUser.id});saveData();showToast('Merma registrada','success');document.getElementById('mermaPeso').value='';document.getElementById('mermaCausa').value='';refreshMermasStats();}
function refreshMermasStats(){const t=new Date().toISOString().split('T')[0];const list=mermas.filter(m=>m.fecha===t);const tm=list.filter(m=>m.tipo==='merma').reduce((s,m)=>s+m.peso,0);const tr=list.filter(m=>m.tipo==='recorte').reduce((s,m)=>s+m.peso,0);const td=list.filter(m=>m.tipo==='desperdicio').reduce((s,m)=>s+m.peso,0);const tp=list.filter(m=>m.tipo==='reproceso').reduce((s,m)=>s+m.peso,0);const e1=document.getElementById('statMermaTotal'),e2=document.getElementById('statRecorte'),e3=document.getElementById('statDesperdicio'),e4=document.getElementById('statReproceso');if(e1)e1.textContent=(tm+tr+td).toFixed(1)+' kg';if(e2)e2.textContent=tr.toFixed(1)+' kg';if(e3)e3.textContent=td.toFixed(1)+' kg';if(e4)e4.textContent=tp.toFixed(1)+' kg';const tb=document.getElementById('tableMermas');if(!tb)return;if(list.length===0){tb.innerHTML='<tr><td colspan="5" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay mermas</td></tr>';return;}tb.innerHTML=list.map(m=>'<tr><td class="text-mono">'+m.hora+'</td><td><span class="badge badge-'+m.linea.toLowerCase()+'">'+m.linea+'</span></td><td><span class="badge badge-danger">'+m.tipo.toUpperCase()+'</span></td><td class="text-mono">'+m.peso+'kg</td><td>'+m.estacion+'</td></tr>').join('');}
function mostrarInfoCoccion(){const l=document.getElementById('prodLineaOp').value;const info=document.getElementById('infoCoccionDerivados');if(info){if(l==='DERIVADOS')info.classList.remove('hidden');else info.classList.add('hidden');}}
function cargarEstacionesLinea(){const l=document.getElementById('prodLineaOp').value,s=document.getElementById('prodEstacionOp');s.innerHTML='<option value="">-- Seleccionar --</option>';if(l&&ESTACIONES[l])ESTACIONES[l].forEach(e=>s.innerHTML+='<option value="'+e+'">'+e+'</option>');}
function guardarProductividad(){const oid=document.getElementById('prodOperario').value,l=document.getElementById('prodLineaOp').value,e=document.getElementById('prodEstacionOp').value,u=parseInt(document.getElementById('prodUnidadesOp').value)||0,h=parseFloat(document.getElementById('prodHorasOp').value)||0;if(!oid||!l||!e||u===0||h===0){showToast('Completa los campos','warning');return;}const op=OPERARIOS.find(o=>o.id===oid);const uh=(u/h).toFixed(1);productividad.push({id:Date.now().toString(),fecha:new Date().toISOString().split('T')[0],operarioId:oid,nombre:op.nombre,linea:l,estacion:e,unidades:u,horas:h,unidadesHora:uh,registradoPor:currentUser.id});saveData();closeModal('modalProductividad');showToast('Productividad registrada','success');refreshProductividadTable();}
function refreshProductividadTable(){const tb=document.getElementById('tableProductividad');if(!tb)return;const t=new Date().toISOString().split('T')[0];const list=productividad.filter(p=>p.fecha===t);if(list.length===0){tb.innerHTML='<tr><td colspan="7" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay registros</td></tr>';return;}tb.innerHTML=list.map(p=>{const lv=parseFloat(p.unidadesHora)>50?'success':parseFloat(p.unidadesHora)>30?'warning':'danger';const lt=lv==='success'?'ALTO':lv==='warning'?'MEDIO':'BAJO';return '<tr><td>'+p.nombre.split(' ')[0]+'</td><td><span class="badge badge-'+p.linea.toLowerCase()+'">'+p.linea+'</span></td><td>'+p.estacion+'</td><td class="text-mono">'+p.unidades+'</td><td class="text-mono">'+p.horas+'h</td><td class="text-mono">'+p.unidadesHora+'</td><td><span class="badge badge-'+lv+'">'+lt+'</span></td></tr>';}).join('');}
function filterProductividad(f,btn){document.querySelectorAll('#mainContent .line-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');const tb=document.getElementById('tableProductividad');const t=new Date().toISOString().split('T')[0];let list=productividad.filter(p=>p.fecha===t);if(f!=='todas')list=list.filter(p=>p.linea===f);if(list.length===0){tb.innerHTML='<tr><td colspan="7" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay registros</td></tr>';return;}tb.innerHTML=list.map(p=>{const lv=parseFloat(p.unidadesHora)>50?'success':parseFloat(p.unidadesHora)>30?'warning':'danger';const lt=lv==='success'?'ALTO':lv==='warning'?'MEDIO':'BAJO';return '<tr><td>'+p.nombre.split(' ')[0]+'</td><td><span class="badge badge-'+p.linea.toLowerCase()+'">'+p.linea+'</span></td><td>'+p.estacion+'</td><td class="text-mono">'+p.unidades+'</td><td class="text-mono">'+p.horas+'h</td><td class="text-mono">'+p.unidadesHora+'</td><td><span class="badge badge-'+lv+'">'+lt+'</span></td></tr>';}).join('');}
function refreshDashboard(){const t=new Date().toISOString().split('T')[0];const oh=ordenes.filter(o=>o.fecha===t);const ph=produccion.filter(p=>p.fecha===t);const so=document.getElementById('statOrdenes');if(so)so.textContent=oh.length;const kc=ph.filter(p=>p.linea==='CRUDOS').reduce((s,p)=>s+(p.kg||0),0);const ka=ph.filter(p=>p.linea==='APANADOS').reduce((s,p)=>s+(p.kg||0),0);const kd=ph.filter(p=>p.linea==='DERIVADOS').reduce((s,p)=>s+(p.kg||0),0);const sc=document.getElementById('statCrudos'),sa=document.getElementById('statApanados'),sd=document.getElementById('statDerivados');if(sc)sc.innerHTML=kc.toFixed(0)+' <span class="stat-unit">kg</span>';if(sa)sa.innerHTML=ka.toFixed(0)+' <span class="stat-unit">kg</span>';if(sd)sd.innerHTML=kd.toFixed(0)+' <span class="stat-unit">kg</span>';const rc=ph.filter(p=>p.linea==='CRUDOS'&&p.rendimiento>0);const ra=ph.filter(p=>p.linea==='APANADOS'&&p.rendimiento>0);const rd=ph.filter(p=>p.linea==='DERIVADOS'&&p.rendimiento>0);const ac=rc.length>0?rc.reduce((s,p)=>s+parseFloat(p.rendimiento),0)/rc.length:0;const aa=ra.length>0?ra.reduce((s,p)=>s+parseFloat(p.rendimiento),0)/ra.length:0;const ad=rd.length>0?rd.reduce((s,p)=>s+parseFloat(p.rendimiento),0)/rd.length:0;const pc=document.getElementById('progressCrudos'),pa=document.getElementById('progressApanados'),pd=document.getElementById('progressDerivados');if(pc)pc.style.width=Math.min(ac,100)+'%';if(pa)pa.style.width=Math.min(aa,100)+'%';if(pd)pd.style.width=Math.min(ad,100)+'%';const erc=document.getElementById('rendCrudos'),era=document.getElementById('rendApanados'),erd=document.getElementById('rendDerivados');if(erc)erc.textContent=ac.toFixed(1)+'%';if(era)era.textContent=aa.toFixed(1)+'%';if(erd)erd.textContent=ad.toFixed(1)+'%';const tb=document.getElementById('tableOrdenesActivas');if(!tb)return;const oa=oh.filter(o=>o.estado!=='completada');if(oa.length===0){tb.innerHTML='<tr><td colspan="5" class="text-center" style="padding:2rem;color:var(--text-muted)">No hay √≥rdenes</td></tr>';return;}tb.innerHTML=oa.slice(0,5).map(o=>'<tr><td class="text-mono">'+o.consecSistema+'</td><td class="text-mono">'+o.consecInterno+'</td><td><span class="badge badge-'+o.linea.toLowerCase()+'">'+o.linea+'</span></td><td>'+o.items.length+'</td><td><span class="badge badge-'+(o.estado==='en_proceso'?'warning':'danger')+'">'+o.estado+'</span></td></tr>').join('');}
function exportarReporte(tipo){const d=(document.getElementById('reporteFechaDesde')||{}).value,h=(document.getElementById('reporteFechaHasta')||{}).value,l=(document.getElementById('reporteLinea')||{}).value;let data=[];if(tipo==='produccion')data=produccion;else if(tipo==='empaques')data=empaques;else if(tipo==='mermas')data=mermas;else if(tipo==='productividad')data=productividad;else if(tipo==='ordenes')data=ordenes.map(o=>({...o,items:o.items.length+' items'}));data=data.filter(x=>x.fecha>=d&&x.fecha<=h);if(l&&l!=='todas')data=data.filter(x=>x.linea===l);if(data.length===0){showToast('No hay datos','warning');return;}const headers=Object.keys(data[0]);const csv=[headers.join(',')].concat(data.map(r=>headers.map(hd=>{let v=r[hd];if(typeof v==='object')v=JSON.stringify(v);return '"'+(v||'')+'"';}).join(','))).join('\n');const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='reporte_'+tipo+'_'+new Date().toISOString().split('T')[0]+'.csv';link.click();showToast('Reporte generado','success');}
</script>
</body>
</html>
